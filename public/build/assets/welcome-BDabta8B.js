import{L as a}from"./leaflet-src-eHmD5uJa.js";window.mapComponent=function(o={}){return{map:null,loading:!0,showBoundaries:!0,showInfrastructures:!0,showLandUses:!0,categories:o.categories||[],selectedCategories:[],allPlaces:[],geoFeatures:[],searchQuery:"",searchResults:[],selectedFeature:null,userMarker:null,markers:[],boundariesLayer:null,infrastructuresLayer:null,landUsesLayer:null,baseLayers:{},currentBaseLayer:"streets",endpoints:{places:o.routes?.places||"/geojson/places",boundaries:o.routes?.boundaries||"/geojson/boundaries",infrastructures:o.routes?.infrastructures||"/geojson/infrastructures",landUses:o.routes?.landUses||"/geojson/land-uses",search:o.routes?.search||"/search/places"},init(){this.selectedCategories=this.categories.map(e=>e.id),this.$nextTick(()=>{this.initMap(),this.fetchAllData()}),this.$watch("selectedCategories",()=>this.updateMapMarkers())},initMap(){if(typeof a>"u"){console.error("Leaflet not loaded");return}this.map=a.map("leaflet-map",{zoomControl:!1,attributionControl:!1,scrollWheelZoom:!1}).setView([-6.59,110.68],10);const e=a.tileLayer("https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),s=a.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});this.baseLayers={streets:e,satellite:s},this.currentBaseLayer="satellite",this.baseLayers.satellite.addTo(this.map)},setBaseLayer(e){this.currentBaseLayer!==e&&(this.map.removeLayer(this.baseLayers[this.currentBaseLayer]),this.currentBaseLayer=e,this.baseLayers[e].addTo(this.map))},async fetchAllData(){this.loading=!0;try{const e=this.endpoints.places,s=await fetch(e);if(!s.ok)throw new Error(`HTTP Error ${s.status}`);const t=await s.json();t.features||console.error("Invalid GeoJSON format:",t),this.geoFeatures=t.features||[],this.allPlaces=t.features||[],this.allPlaces.length===0&&console.warn("Warning: No places received from server."),this.updateMapMarkers()}catch(e){console.error("PLACES FETCH ERROR:",e)}try{const[e,s,t]=await Promise.all([fetch(this.endpoints.boundaries).then(r=>r.json()),fetch(this.endpoints.infrastructures).then(r=>r.json()),fetch(this.endpoints.landUses).then(r=>r.json())]);this.loadBoundaries(e.features||[]),this.loadInfrastructures(s.features||[]),this.loadLandUses(t.features||[])}catch(e){console.error("Layer load error:",e)}finally{this.loading=!1}},updateLayers(){this.fetchAllData()},loadBoundaries(e){this.boundariesLayer&&this.map.removeLayer(this.boundariesLayer),this.showBoundaries&&(this.boundariesLayer=a.geoJSON(e,{style:{color:"#059669",weight:2,fillColor:"#10b981",fillOpacity:.1,dashArray:"5, 5"},onEachFeature:(s,t)=>{t.on("click",r=>{a.DomEvent.stop(r),this.selectFeature({...s.properties,type:"Batas Wilayah"})})}}).addTo(this.map))},loadInfrastructures(e){this.infrastructuresLayer&&this.map.removeLayer(this.infrastructuresLayer),this.showInfrastructures&&(this.infrastructuresLayer=a.geoJSON(e,{style:s=>{const t=s.properties.type;return{color:t==="river"?"#3b82f6":"#64748b",weight:t==="river"?4:3,opacity:.8}},onEachFeature:(s,t)=>{t.on("click",r=>{a.DomEvent.stop(r),this.selectFeature({...s.properties,type:"Infrastruktur"})})}}).addTo(this.map))},loadLandUses(e){this.landUsesLayer&&this.map.removeLayer(this.landUsesLayer),this.showLandUses&&(this.landUsesLayer=a.geoJSON(e,{style:s=>{const t={rice_field:"#fbbf24",forest:"#15803d",settlement:"#f97316",plantation:"#84cc16"};return{color:t[s.properties.type]||"#94a3b8",weight:1,fillOpacity:.3,fillColor:t[s.properties.type]}},onEachFeature:(s,t)=>{t.on("click",r=>{a.DomEvent.stop(r),this.selectFeature({...s.properties,type:"Penggunaan Lahan"})})}}).addTo(this.map))},updateMapMarkers(){this.markers.forEach(s=>this.map.removeLayer(s)),this.markers=[],this.geoFeatures.filter(s=>this.selectedCategories.includes(s.properties.category?.id)).forEach(s=>{const[t,r]=s.geometry.coordinates,n=s.properties,l=a.icon({iconUrl:"/images/titik-point.png",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]}),i=a.marker([r,t],{icon:l});i.on("click",()=>{this.selectPlace({...n,latitude:r,longitude:t})}),i.addTo(this.map),this.markers.push(i)})},performSearch(){const e=this.searchQuery;if(!e){this.searchResults=[];return}fetch(`${this.endpoints.search}?q=${encodeURIComponent(e)}`).then(s=>s.json()).then(s=>{this.searchResults=s}).catch(s=>{console.error("Search Error:",s)})},selectFeature(e){if(e.url){window.location.href=e.url;return}this.selectedFeature=e,this.zoomToFeature(e),this.searchResults=[]},getIconClass(e){switch(e){case"Destinasi":return"fa-solid fa-location-dot";case"Berita":return"fa-solid fa-newspaper";case"Agenda":return"fa-solid fa-calendar-alt";case"Budaya":return"fa-solid fa-masks-theater";case"Kuliner":return"fa-solid fa-utensils";default:return"fa-solid fa-search"}},selectPlace(e){this.selectedFeature={...e,type:"Lokasi",image_url:e.image_url||null},this.zoomToFeature(e)},zoomToFeature(e){if(e.coords)this.map.flyTo(e.coords,18);else if(e.latitude&&e.longitude)this.map.flyTo([e.latitude,e.longitude],18);else if(e.geometry){const s=a.geoJSON(e);this.map.fitBounds(s.getBounds(),{padding:[50,50]})}},scrollToMap(){document.getElementById("gis-map").scrollIntoView({behavior:"smooth"})},locateUser(){if(!navigator.geolocation){alert("Browser tidak mendukung geolokasi");return}this.loading=!0,navigator.geolocation.getCurrentPosition(e=>{const{latitude:s,longitude:t}=e.coords;this.map.flyTo([s,t],17),this.userMarker&&this.map.removeLayer(this.userMarker),this.userMarker=a.marker([s,t],{icon:a.divIcon({html:'<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg marker-pulse"></div>',iconSize:[16,16]})}).addTo(this.map),this.loading=!1},e=>{console.error(e),this.loading=!1,alert("Gagal mengambil lokasi.")})},getDirectionsUrl(e){let s,t;return e.latitude&&e.longitude?(s=e.latitude,t=e.longitude):e.coords?(s=e.coords[0],t=e.coords[1]):e.geometry&&e.geometry.type==="Point"&&(t=e.geometry.coordinates[0],s=e.geometry.coordinates[1]),s&&t?`https://www.google.com/maps/dir/?api=1&destination=${s},${t}`:null}}};
