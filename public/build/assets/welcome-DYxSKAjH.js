import{L as o}from"./leaflet-src-eHmD5uJa.js";window.mapComponent=function(a={}){return{map:null,loading:!0,showBoundaries:!0,showInfrastructures:!0,showLandUses:!0,categories:a.categories||[],selectedCategories:[],allPlaces:[],geoFeatures:[],searchQuery:"",searchResults:[],selectedFeature:null,userMarker:null,markers:[],boundariesLayer:null,infrastructuresLayer:null,landUsesLayer:null,baseLayers:{},currentBaseLayer:"streets",endpoints:{places:a.routes?.places||"/geojson/places",boundaries:a.routes?.boundaries||"/geojson/boundaries",infrastructures:a.routes?.infrastructures||"/geojson/infrastructures",landUses:a.routes?.landUses||"/geojson/land-uses",search:a.routes?.search||"/search/places"},init(){this.selectedCategories=this.categories.map(e=>e.id),this.$nextTick(()=>{this.initMap(),this.fetchAllData()}),this.$watch("selectedCategories",()=>this.updateMapMarkers())},initMap(){if(typeof o>"u"){console.error("Leaflet not loaded");return}this.map=o.map("leaflet-map",{zoomControl:!1,attributionControl:!1,scrollWheelZoom:!1}).setView([-6.59,110.68],10);const e=o.tileLayer("https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),t=o.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]});this.baseLayers={streets:e,satellite:t},this.currentBaseLayer="satellite",this.baseLayers.satellite.addTo(this.map)},setBaseLayer(e){this.currentBaseLayer!==e&&(this.map.removeLayer(this.baseLayers[this.currentBaseLayer]),this.currentBaseLayer=e,this.baseLayers[e].addTo(this.map))},async fetchAllData(){this.loading=!0;try{const e=this.endpoints.places,t=await fetch(e);if(!t.ok)throw new Error(`HTTP Error ${t.status}`);const s=await t.json();s.features||console.error("Invalid GeoJSON format:",s),this.geoFeatures=s.features||[],this.allPlaces=s.features||[],this.allPlaces.length===0&&console.warn("Warning: No places received from server."),this.updateMapMarkers()}catch(e){console.error("PLACES FETCH ERROR:",e)}try{const[e,t,s]=await Promise.all([fetch(this.endpoints.boundaries).then(r=>r.json()),fetch(this.endpoints.infrastructures).then(r=>r.json()),fetch(this.endpoints.landUses).then(r=>r.json())]);this.loadBoundaries(e.features||[]),this.loadInfrastructures(t.features||[]),this.loadLandUses(s.features||[])}catch(e){console.error("Layer load error:",e)}finally{this.loading=!1}},updateLayers(){this.fetchAllData()},loadBoundaries(e){this.boundariesLayer&&this.map.removeLayer(this.boundariesLayer),this.showBoundaries&&(this.boundariesLayer=o.geoJSON(e,{style:{color:"#059669",weight:2,fillColor:"#10b981",fillOpacity:.1,dashArray:"5, 5"},onEachFeature:(t,s)=>{s.on("click",r=>{o.DomEvent.stop(r),this.selectFeature({...t.properties,type:"Batas Wilayah"})})}}).addTo(this.map))},loadInfrastructures(e){this.infrastructuresLayer&&this.map.removeLayer(this.infrastructuresLayer),this.showInfrastructures&&(this.infrastructuresLayer=o.geoJSON(e,{style:t=>{const s=t.properties.type;return{color:s==="river"?"#3b82f6":"#64748b",weight:s==="river"?4:3,opacity:.8}},onEachFeature:(t,s)=>{s.on("click",r=>{o.DomEvent.stop(r),this.selectFeature({...t.properties,type:"Infrastruktur"})})}}).addTo(this.map))},loadLandUses(e){this.landUsesLayer&&this.map.removeLayer(this.landUsesLayer),this.showLandUses&&(this.landUsesLayer=o.geoJSON(e,{style:t=>{const s={rice_field:"#fbbf24",forest:"#15803d",settlement:"#f97316",plantation:"#84cc16"};return{color:s[t.properties.type]||"#94a3b8",weight:1,fillOpacity:.3,fillColor:s[t.properties.type]}},onEachFeature:(t,s)=>{s.on("click",r=>{o.DomEvent.stop(r),this.selectFeature({...t.properties,type:"Penggunaan Lahan"})})}}).addTo(this.map))},updateMapMarkers(){this.markers.forEach(t=>this.map.removeLayer(t)),this.markers=[],this.geoFeatures.filter(t=>this.selectedCategories.includes(t.properties.category?.id)).forEach(t=>{const[s,r]=t.geometry.coordinates,i=t.properties,n=`
                <div class="w-9 h-9 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white text-sm custom-marker" style="background: linear-gradient(to bottom right, ${i.category?i.category.color:"#3b82f6"}, #475569);">
                    <i class="${i.category?.icon_class??"fa-solid fa-map-marker-alt"}"></i>
                </div>
            `,l=o.marker([r,s],{icon:o.divIcon({html:n,className:"",iconSize:[36,36],iconAnchor:[18,18]})});l.on("click",()=>{this.selectPlace({...i,latitude:r,longitude:s})}),l.addTo(this.map),this.markers.push(l)})},performSearch(){const e=this.searchQuery;if(!e){this.searchResults=[];return}fetch(`${this.endpoints.search}?q=${encodeURIComponent(e)}`).then(t=>t.json()).then(t=>{this.searchResults=t}).catch(t=>{console.error("Search Error:",t)})},selectFeature(e){if(e.slug){window.location.href=`/destinasi/${e.slug}`;return}this.selectedFeature=e,this.zoomToFeature(e),this.searchResults=[]},selectPlace(e){this.selectedFeature={...e,type:"Lokasi",image_url:e.image_url||null},this.zoomToFeature(e)},zoomToFeature(e){if(e.coords)this.map.flyTo(e.coords,18);else if(e.latitude&&e.longitude)this.map.flyTo([e.latitude,e.longitude],18);else if(e.geometry){const t=o.geoJSON(e);this.map.fitBounds(t.getBounds(),{padding:[50,50]})}},scrollToMap(){document.getElementById("gis-map").scrollIntoView({behavior:"smooth"})},locateUser(){if(!navigator.geolocation){alert("Browser tidak mendukung geolokasi");return}this.loading=!0,navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:s}=e.coords;this.map.flyTo([t,s],17),this.userMarker&&this.map.removeLayer(this.userMarker),this.userMarker=o.marker([t,s],{icon:o.divIcon({html:'<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg marker-pulse"></div>',iconSize:[16,16]})}).addTo(this.map),this.loading=!1},e=>{console.error(e),this.loading=!1,alert("Gagal mengambil lokasi.")})},getDirectionsUrl(e){let t,s;return e.latitude&&e.longitude?(t=e.latitude,s=e.longitude):e.coords?(t=e.coords[0],s=e.coords[1]):e.geometry&&e.geometry.type==="Point"&&(s=e.geometry.coordinates[0],t=e.geometry.coordinates[1]),t&&s?`https://www.google.com/maps/dir/?api=1&destination=${t},${s}`:null}}};
